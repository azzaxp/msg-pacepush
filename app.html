<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="manifest" href="./manifest.json" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
    <style>
        #mapid {
            height: 350px;
        }
    </style>
    <script>
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function () {
            OneSignal.init({
                appId: "97d1c30b-7d65-4789-8fdd-108be348748a",
                notifyButton: {
                    enable: true,
                }
            });
            OneSignal.showNativePrompt();
        });

    </script>
</head>

<body>
    <h2>Push Notification</h2>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Similique aliquam corrupti culpa hic fuga adipisci?
        Culpa earum perferendis necessitatibus eaque obcaecati, sit dolorem labore ab deserunt praesentium illo debitis
        minus!</p>

    <div id="mapid"></div>
    <p><button onclick="geoFindMe()">Show my location</button></p>
    <div id="out"></div>

    <script>
        const mymap = L.map('mapid').setView([13.05, 74.96], 9);
        var marker = L.marker([0, 0]).addTo(mymap);
        var popup = L.popup();


        function onMapClick(e) {
            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString())
                .openOn(mymap);
            clat = e.latlng.lat;
            clong = e.latlng.lng;
            const loca = { clat, clong };
            console.log(loca)
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(loca)
            };
            fetch('/api/location', options).then(Response => {
                console.log(Response);
            });


            var circle = L.circle(e.latlng, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 150000
            }).addTo(mymap);


            marker.setLatLng(e.latlng);

        }

        mymap.on('click', onMapClick);


        const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        const tilesUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        const tiles = L.tileLayer(tilesUrl, { attribution });
        tiles.addTo(mymap);


    </script>
    <script>
        var output = document.getElementById("out");
        function geoFindMe() {
            if (!navigator.geolocation) {
                output.innerHTML = "<p>Geolocation is not supported by your browser</p>";
                return;
            }
            output.innerHTML = "<p>Locating…</p>";
            navigator.geolocation.getCurrentPosition(success, error);
        }

        function success(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            //L.marker([latitude, longitude]).addTo(mymap);
            output.innerHTML = '<p>Latitude is ' + latitude + '° <br>Longitude is ' + longitude + '°</p>';

            OneSignal.push(function () {
                OneSignal.sendTags({
                    lat: latitude,
                    long: longitude
                }).then(tagSent => {
                    console.log(tagSent)
                });
            });


            // //sending lan and long
            // const data = { latitude, longitude };
            // const options = {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify(data)
            // };
            // fetch('/api/location', options).then(Response => {
            //     console.log(Response);
            // });

            // var img = new Image();
            // img.src = "https://maps.googleapis.com/maps/api/staticmap?center=" + latitude + "," + longitude + "&zoom=13&size=300x300&sensor=false";

            output.appendChild(img);
        }

        function error() {
            output.innerHTML = "Unable to retrieve your location";
        }
    </script>
</body>

</html>